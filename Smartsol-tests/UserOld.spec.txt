const { test, expect } = require('@playwright/test');

//POM Class
const { Authentication } = require('../pageObject/Authentication');
const {CreateUser} = require("../pageObject/CreateUser")


test.only("Create Super Admin User", async ({page})=> {
    const auth = new Authentication(page);
    const createUser = new CreateUser(page);

    await auth.loginPage('harsha@tparamount.com', 'password');
    await createUser.profileIcon.click();
    await createUser.settings.click();
    await createUser.userlink.click();

    await page.waitForTimeout(2000);
    const beforeRowCount = await createUser.tableLocator.count();
    console.log(beforeRowCount);


    const firstname = 'FirstName'
    const lastName = 'lastName'

    await createUser.userbtn.click();
    await createUser.firstName.fill(firstname);
    await createUser.lastName.fill(lastName);
    await createUser.email.fill("email@gmail.com");
    await createUser.password.fill("password");

    await createUser.role.selectOption({label : "Super Admin"});
    await createUser.phone.fill("8989123476");
    
    // await createUser.location.selectOption({label : "GUJRAT"});

    await createUser.submit.click();


    await page.waitForTimeout(2000);
    const afterRowCount = await createUser.tableLocator.count();
    expect(afterRowCount).toBe(beforeRowCount+1);
    console.log(afterRowCount, beforeRowCount)
    // await page.pause()

    // update the existing user
    await page.waitForTimeout(2000);
    const updaterows = await createUser.tableLocator;
    await selectUser(updaterows,page,`${firstname} ${lastName}`)

    const lastName2 = "lastName2"
    await createUser.editdropdown.click();
    await createUser.edit.click();
    await createUser.lastName.fill(lastName2);
    await createUser.submit.click();
    // await page.pause()

    // delete existing user
    // await page.pause()
    await page.waitForTimeout(2000);
    const deleterows = await createUser.tableLocator;
    await selectUser(deleterows,page,`${firstname} ${lastName2}`)
    await createUser.editdropdown.click();
    await createUser.deletebtn.click();
    await createUser.deletePopupBtn.click();
    // await page.pause()

    await page.waitForTimeout(1000);
    const afterDeleteRowCount = await createUser.tableLocator.count();
    expect(beforeRowCount).toBe(afterDeleteRowCount);



})

test("Update Super admin user", async ({page})=> {
    const auth = new Authentication(page);
    const createUser = new CreateUser(page);

    await auth.loginPage('harsha@tparamount.com', 'password');


    await createUser.profileIcon.click();
    await createUser.settings.click();
    await createUser.userlink.click();

    const table = await page.locator("table");

    const columns = await table.locator("thead tr th")
    console.log("no of columns", await columns.count()); 
    // expect(await columns.count()).toBe(6);

    await page.waitForTimeout(2000);

    const rows = await table.locator("tbody tr")
    console.log("no of rows", await rows.count());
    // expect(await rows.count()).toBe(6);

    // const matchedRow = rows.filter({
    //     has : page.locator("td"),
    //     hasText : "Jigar last name"
    // })

    // await matchedRow.locator("input").check();

    await selectUser(rows,page,"Jigar last name")
    
    await page.locator("//button[@type='button']").click();

    await createUser.edit.click();

    await createUser.lastName.fill("last name");

    await createUser.submit.click();


    await page.pause()
})

async function selectUser(rows, page ,name){
    const matchedRow = rows.filter({
        has : page.locator("td"),
        hasText :name
    })

    await matchedRow.locator("input").check();
    
}

test("read table data", async({page})=> {
    const auth = new Authentication(page);
    const createUser = new CreateUser(page);
    console.log("read table data");
    await auth.loginPage('harsha@tparamount.com', 'password');
    await createUser.profileIcon.click();
    await createUser.settings.click();
    await createUser.userlink.click();
    await readTableData(page);

    // await page.pause();


})
async function readTableData(page) {
    const table = await page.locator("table");

    const columns = await table.locator("thead tr th")
    console.log("no of columns", await columns.count()); 
    // expect(await columns.count()).toBe(6);

    await page.waitForTimeout(2000);

    const rows = await table.locator("tbody tr")
    console.log("no of rows", await rows.count());

    for(let i = 0; i < await rows.count();i++){
        const row = rows.nth(i);
        const tds = row.locator("td");
        for(let j =0; j < await tds.count(); j++){
            const cellContent = await tds.nth(j).textContent();
            console.log(cellContent);
        }
    }
}